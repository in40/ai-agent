# Enhancement: Schema Export with Comments

## Overview
This enhancement adds support for exporting database schema comments (for tables, columns, etc.) to help LLM models better understand the context of the database structure. This improves the accuracy and relevance of SQL queries generated by the AI agent.

## Changes Made

### 1. Database Schema Retrieval (`utils/database.py`)
- **PostgreSQL Support**: Modified the schema retrieval query to include table and column comments from PostgreSQL's system catalogs (`pg_description`)
- **SQLite Support**: Enhanced the schema retrieval to extract comments from CREATE TABLE statements where possible (since SQLite doesn't have native comment support)
- **Backward Compatibility**: Maintained compatibility with existing code by preserving the original data structure while extending it with comment information

### 2. Schema Formatting (`models/sql_generator.py`)
- Updated the `format_schema_dump` method to handle both the old format (without comments) and new format (with comments)
- Enhanced the formatting to include comments in the output string sent to the LLM
- Preserved backward compatibility for schemas without comments

## Technical Details

### PostgreSQL Implementation
- Used `pg_catalog.pg_description` to retrieve table and column comments
- Joined with `pg_catalog.pg_statio_all_tables` to link comments to tables and columns
- Table comments are retrieved separately from column comments
- Column comments are retrieved alongside column metadata

### SQLite Implementation  
- Extracted column comments from CREATE TABLE statements using regex patterns
- Attempted to extract table comments from the end of CREATE TABLE statements (though SQLite typically strips these)
- Since SQLite doesn't have native comment support, this implementation extracts comments from the original DDL if they exist

### Backward Compatibility
- The schema structure now supports both formats:
  - Old format: `{table_name: [columns_list]}`
  - New format: `{table_name: {'columns': [columns_list], 'comment': table_comment}}`
- The formatting function handles both formats gracefully

## Benefits
1. **Improved LLM Understanding**: Comments provide additional context about the purpose and meaning of tables and columns
2. **Better Query Generation**: LLMs can leverage comments to generate more accurate and relevant SQL queries
3. **Enhanced Documentation**: Schema exports now include valuable documentation that was previously unavailable
4. **Database Agnostic**: Works with both PostgreSQL and SQLite databases

## Example Output
```
Table: users - Comment: Table for storing user information
  - id (INTEGER) - Nullable: True
  - name (TEXT) - Nullable: False - Comment: User's full name
  - email (TEXT) - Nullable: True - Comment: User's email address
  - created_at (TIMESTAMP) - Nullable: True - Comment: When the user was created

Table: orders - Comment: Table for storing order information
  - id (INTEGER) - Nullable: True
  - user_id (INTEGER) - Nullable: True - Comment: Reference to the user who placed the order
  - product_name (TEXT) - Nullable: True - Comment: Name of the product ordered
  - quantity (INTEGER) - Nullable: True - Comment: Number of items ordered
  - total_price (REAL) - Nullable: True - Comment: Total price of the order
```

## Testing
- Created comprehensive tests for both PostgreSQL and SQLite schema export with comments
- Verified that comments are properly extracted and formatted for LLM consumption
- Confirmed backward compatibility with existing functionality